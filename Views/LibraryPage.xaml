<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="NovelBook.Views.LibraryPage"
             Title="Mi LibrerÃ­a"
             BackgroundColor="{StaticResource BackgroundDark}">

    <Grid Padding="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Barra de bÃºsqueda -->
        <SearchBar x:Name="searchBar"
                   Placeholder="Buscar en mi librerÃ­a..."
                   PlaceholderColor="{StaticResource TextMuted}"
                   TextColor="{StaticResource TextPrimary}"
                   BackgroundColor="{StaticResource BackgroundMedium}"
                   Grid.Row="0"
                   Margin="0,0,0,10"
                   TextChanged="OnSearchTextChanged"/>

        <!-- Filtros y botÃ³n de ordenamiento -->
        <Grid Grid.Row="1">
            <ScrollView Orientation="Horizontal"
                        HeightRequest="50"
                        Margin="0,0,0,10"
                        Padding="0,0,0,5">
                <HorizontalStackLayout x:Name="FilterLayout" Spacing="10">
                    <Button Text="ðŸ“” Todos" 
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            CornerRadius="15"
                            Padding="15,5"
                            Clicked="OnFilterClicked"/>
                    <Button Text="ðŸ§¾ Leyendo" 
                            BackgroundColor="{StaticResource BackgroundMedium}"
                            TextColor="{StaticResource TextSecondary}"
                            CornerRadius="15"
                            Padding="15,5"
                            Clicked="OnFilterClicked"/>
                    <Button Text="âœ”ï¸ Completados" 
                            BackgroundColor="{StaticResource BackgroundMedium}"
                            TextColor="{StaticResource TextSecondary}"
                            CornerRadius="15"
                            Padding="15,5"
                            Clicked="OnFilterClicked"/>
                    <Button Text="â­ Favoritos" 
                            BackgroundColor="{StaticResource BackgroundMedium}"
                            TextColor="{StaticResource TextSecondary}"
                            CornerRadius="15"
                            Padding="15,5"
                            Clicked="OnFilterClicked"/>
                    <Button Text="â¸ï¸ En pausa" 
                            BackgroundColor="{StaticResource BackgroundMedium}"
                            TextColor="{StaticResource TextSecondary}"
                            CornerRadius="15"
                            Padding="15,5"
                            Clicked="OnFilterClicked"/>
                    <Button Text="ðŸ“‹ Planeo leer" 
                            BackgroundColor="{StaticResource BackgroundMedium}"
                            TextColor="{StaticResource TextSecondary}"
                            CornerRadius="15"
                            Padding="15,5"
                            Clicked="OnFilterClicked"/>
                </HorizontalStackLayout>
            </ScrollView>

            <!-- BotÃ³n de ordenamiento -->
            <Button Text="â‡…"
                    BackgroundColor="{StaticResource BackgroundMedium}"
                    TextColor="{StaticResource TextPrimary}"
                    WidthRequest="40"
                    HeightRequest="40"
                    CornerRadius="20"
                    HorizontalOptions="End"
                    VerticalOptions="Start"
                    Margin="10"
                    Clicked="OnSortClicked"/>
        </Grid>

        <!-- CONTENEDOR PRINCIPAL para Row 2 -->
        <Grid Grid.Row="2">
            <!-- ScrollView con CollectionView -->
            <ScrollView x:Name="CollectionScrollView" IsVisible="True">
                <CollectionView x:Name="novelsCollection">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" 
                                         Span="2" 
                                         VerticalItemSpacing="10" 
                                         HorizontalItemSpacing="10"/>
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="{StaticResource BackgroundMedium}"
                                   CornerRadius="10"
                                   Padding="0"
                                   HasShadow="True">

                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="200"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- SOLO tap gesture en el Frame principal -->
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnNovelTapped"/>
                                    </Grid.GestureRecognizers>

                                    <!-- Imagen de portada -->
                                    <Image Source="{Binding CoverImageSource}"
                                           Aspect="AspectFill"
                                           Grid.Row="0"/>

                                    <!-- Contador de capÃ­tulos sin leer -->
                                    <Frame BackgroundColor="{StaticResource Primary}"
                                           CornerRadius="15"
                                           Padding="8,4"
                                           HorizontalOptions="Start"
                                           VerticalOptions="Start"
                                           Margin="5"
                                           Grid.Row="0"
                                           IsVisible="{Binding ShowUnreadBadge}">
                                        <Label Text="{Binding UnreadCount}"
                                               TextColor="White"
                                               FontSize="12"
                                               FontAttributes="Bold"/>
                                    </Frame>

                                    <!-- Indicador de favorito -->
                                    <Frame BackgroundColor="#FFD700"
                                           CornerRadius="15"
                                           Padding="6,4"
                                           HorizontalOptions="Start"
                                           VerticalOptions="Start"
                                           Margin="5"
                                           Grid.Row="0"
                                           IsVisible="{Binding IsFavorite}">
                                        <Label Text="â­"
                                               TextColor="White"
                                               FontSize="12"/>
                                    </Frame>

                                    <!-- BotÃ³n de menÃº (tres puntos) para opciones -->
                                    <Button Text="â‹®"
                                            BackgroundColor="{StaticResource BackgroundMedium}"
                                            TextColor="White"
                                            FontSize="20"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            CornerRadius="20"
                                            HorizontalOptions="End"
                                            VerticalOptions="Start"
                                            Margin="5"
                                            Grid.Row="0"
                                            Clicked="OnNovelMenuClicked"
                                            Opacity="0.8"/>

                                    <!-- TÃ­tulo y informaciÃ³n -->
                                    <VerticalStackLayout Grid.Row="1" 
                                                       Padding="10"
                                                       Spacing="5">
                                        <Label Text="{Binding Title}"
                                               TextColor="{StaticResource TextPrimary}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               MaxLines="2"
                                               LineBreakMode="TailTruncation"/>
                                        <!--Boton autor-->
                                        <Label Text="{Binding Author}"
                                               TextColor="{StaticResource TextSecondary}"
                                               FontSize="12"
                                               LineBreakMode="TailTruncation">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnAuthorTapped" 
                                                                      CommandParameter="{Binding Author}"/>
                                            </Label.GestureRecognizers>
                                        </Label>

                                        <HorizontalStackLayout Spacing="10">
                                            <Label TextColor="{StaticResource TextMuted}"
                                                   FontSize="11">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span Text="ðŸ“– "/>
                                                        <Span Text="{Binding ChapterCount}"/>
                                                        <Span Text=" caps"/>
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>

                                            <Label TextColor="{StaticResource TextMuted}"
                                                   FontSize="11">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span Text="ðŸ“š "/>
                                                        <Span Text="{Binding LastReadChapter}"/>
                                                        <Span Text=" leÃ­do"/>
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </ScrollView>

            <!-- Indicador de carga -->
            <ActivityIndicator x:Name="LoadingIndicator"
                               Color="{StaticResource Primary}"
                               IsVisible="False"
                               IsRunning="False"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>

            <!-- Estado vacÃ­o - AL FINAL para estar encima -->
            <VerticalStackLayout x:Name="EmptyStateLayout"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="20"
                                 IsVisible="False"
                                 BackgroundColor="{StaticResource BackgroundDark}">
                <Label Text="ðŸ“š"
                       FontSize="60"
                       HorizontalOptions="Center"/>
                <Label x:Name="EmptyStateMessage"
                       Text="Tu biblioteca estÃ¡ vacÃ­a"
                       TextColor="{StaticResource TextSecondary}"
                       FontSize="16"
                       HorizontalOptions="Center"/>
                <Button Text="Explorar novelas"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        CornerRadius="20"
                        Padding="20,10"
                        Clicked="OnExploreNovelsClicked"
                        HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>