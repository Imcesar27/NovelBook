<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="NovelBook.Views.DownloadsPage"
             Title="Descargas"
             BackgroundColor="{StaticResource BackgroundDark}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- InformaciÃ³n de almacenamiento -->
        <Frame Grid.Row="0"
               BackgroundColor="{StaticResource BackgroundMedium}"
               CornerRadius="10"
               Margin="10"
               Padding="15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Label Grid.Row="0"
                       Text="Espacio usado"
                       TextColor="{StaticResource TextSecondary}"
                       FontSize="14"/>

                <ProgressBar Grid.Row="1"
                             x:Name="StorageProgressBar"
                             Progress="0"
                             ProgressColor="{StaticResource Primary}"
                             BackgroundColor="{StaticResource BackgroundLight}"
                             HeightRequest="10"
                             Margin="0,10"/>

                <HorizontalStackLayout Grid.Row="2" Spacing="10">
                    <Label x:Name="StorageLabel"
                           TextColor="{StaticResource TextPrimary}"
                           FontSize="12"/>
                    <Label Text="â€¢" TextColor="{StaticResource TextMuted}"/>
                    <Label x:Name="DownloadCountLabel"
                           Text="0 novelas descargadas"
                           TextColor="{StaticResource TextSecondary}"
                           FontSize="12"/>
                </HorizontalStackLayout>
            </Grid>
        </Frame>

        <!-- Opciones de gestiÃ³n -->
        <HorizontalStackLayout Grid.Row="1" 
                             Spacing="10"
                             Padding="10,0"
                             HorizontalOptions="End">
            <Button x:Name="SelectButton"
                    Text="Seleccionar"
                    BackgroundColor="{StaticResource BackgroundMedium}"
                    TextColor="{StaticResource TextPrimary}"
                    CornerRadius="15"
                    Padding="15,5"
                    FontSize="12"
                    Clicked="OnSelectClicked"/>
            <Button Text="Ordenar"
                    BackgroundColor="{StaticResource BackgroundMedium}"
                    TextColor="{StaticResource TextPrimary}"
                    CornerRadius="15"
                    Padding="15,5"
                    FontSize="12"
                    Clicked="OnSortClicked"/>
        </HorizontalStackLayout>

        <!-- Lista de descargas -->
        <ScrollView Grid.Row="2" Padding="10">
            <Grid>
                <!-- Indicador de carga -->
                <ActivityIndicator x:Name="LoadingIndicator"
                                   IsRunning="False"
                                   IsVisible="False"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center"
                                   Color="{StaticResource Primary}"/>

                <!-- Lista de novelas descargadas -->
                <CollectionView x:Name="DownloadsList"
                                IsVisible="False">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="{StaticResource BackgroundMedium}"
                                   CornerRadius="10"
                                   Padding="15"
                                   Margin="0,5"
                                   HasShadow="False">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnNovelTapped"/>
                                </Frame.GestureRecognizers>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Portada con indicador de selecciÃ³n -->
                                    <Grid Grid.Column="0">
                                        <Image Source="{Binding CoverSource}"
                                               Aspect="AspectFill"
                                               HeightRequest="100"
                                               WidthRequest="80"/>

                                        <!-- Checkbox de selecciÃ³n -->
                                        <CheckBox IsChecked="{Binding IsSelected}"
                                                  Opacity="{Binding SelectionOpacity}"
                                                  VerticalOptions="Start"
                                                  HorizontalOptions="Start"
                                                  Margin="5"
                                                  Scale="0.8"/>

                                        <!-- Indicador de descarga completa -->
                                        <Frame IsVisible="{Binding IsComplete}"
                                               BackgroundColor="{StaticResource Success}"
                                               CornerRadius="10"
                                               Padding="5,2"
                                               VerticalOptions="End"
                                               HorizontalOptions="Center"
                                               Margin="0,0,0,5">
                                            <Label Text="âœ“"
                                                   TextColor="White"
                                                   FontSize="10"/>
                                        </Frame>
                                    </Grid>

                                    <!-- InformaciÃ³n de la novela -->
                                    <VerticalStackLayout Grid.Column="1"
                                                         Padding="10,0"
                                                         Spacing="5">
                                        <Label Text="{Binding Title}"
                                               TextColor="{StaticResource TextPrimary}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1"/>

                                        <Label Text="{Binding Author}"
                                               TextColor="{StaticResource TextSecondary}"
                                               FontSize="14"
                                               LineBreakMode="TailTruncation"/>

                                        <Label Text="{Binding ChaptersText}"
                                               TextColor="{StaticResource TextMuted}"
                                               FontSize="12"/>

                                        <!-- Barra de progreso -->
                                        <ProgressBar Progress="{Binding ProgressValue}"
                                                     ProgressColor="{StaticResource Primary}"
                                                     BackgroundColor="{StaticResource BackgroundLight}"
                                                     HeightRequest="4"/>

                                        <Label Text="{Binding SizeText}"
                                               TextColor="{StaticResource TextMuted}"
                                               FontSize="12"/>
                                    </VerticalStackLayout>

                                    <!-- BotÃ³n de opciones -->
                                    <Button Grid.Column="2"
                                            Text="â‹®"
                                            BackgroundColor="Transparent"
                                            TextColor="{StaticResource TextSecondary}"
                                            FontSize="20"
                                            VerticalOptions="Start"
                                            Clicked="OnMoreOptionsClicked"/>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Estado vacÃ­o -->
                <VerticalStackLayout x:Name="EmptyState"
                                     IsVisible="False"
                                     VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Spacing="10"
                                     Padding="20">
                    <Label Text="ðŸ“¥"
                           FontSize="60"
                           HorizontalOptions="Center"/>
                    <Label Text="No hay descargas"
                           TextColor="{StaticResource TextSecondary}"
                           FontSize="16"
                           HorizontalOptions="Center"/>
                    <Label Text="Descarga novelas para leer sin conexiÃ³n"
                           TextColor="{StaticResource TextMuted}"
                           FontSize="14"
                           HorizontalOptions="Center"/>
                    <Button Text="Explorar novelas"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            CornerRadius="20"
                            Padding="20,10"
                            Margin="0,20,0,0"
                            Clicked="OnExploreClicked"/>
                </VerticalStackLayout>
            </Grid>
        </ScrollView>

        <!-- Modo selecciÃ³n (oculto por defecto) -->
        <Grid Grid.Row="2"
              x:Name="SelectionBar"
              BackgroundColor="{StaticResource BackgroundMedium}"
              Padding="15"
              VerticalOptions="End"
              IsVisible="False">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Label Grid.Column="0"
                   x:Name="SelectionLabel"
                   Text="0 seleccionados"
                   TextColor="{StaticResource TextPrimary}"
                   VerticalOptions="Center"/>

            <HorizontalStackLayout Grid.Column="1" Spacing="10">
                <Button Text="Eliminar"
                        BackgroundColor="{StaticResource Error}"
                        TextColor="White"
                        CornerRadius="15"
                        Padding="15,8"
                        FontSize="12"
                        Clicked="OnDeleteSelectedClicked"/>
                <Button Text="Cancelar"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        TextColor="{StaticResource TextPrimary}"
                        CornerRadius="15"
                        Padding="15,8"
                        FontSize="12"
                        Clicked="OnCancelSelectionClicked"/>
            </HorizontalStackLayout>
        </Grid>
    </Grid>
</ContentPage>