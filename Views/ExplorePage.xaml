<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="NovelBook.Views.ExplorePage"
             Title="Explorar"
             BackgroundColor="{StaticResource BackgroundDark}">

    <Grid Padding="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Barra de bÃºsqueda con estilo personalizado -->
        <Frame Grid.Row="0" 
               BackgroundColor="{StaticResource BackgroundMedium}"
               CornerRadius="20"
               Padding="5,0"
               Margin="0,5,0,10"
               HasShadow="False">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Label Text="ðŸ”" 
                       FontSize="20"
                       VerticalOptions="Center"
                       Margin="10,0,5,0"
                       Grid.Column="0"/>

                <Entry x:Name="searchEntry"
                       Placeholder="Search"
                       PlaceholderColor="{StaticResource TextMuted}"
                       TextColor="{StaticResource TextPrimary}"
                       BackgroundColor="Transparent"
                       VerticalOptions="Center"
                       Grid.Column="1"/>

                <ImageButton Source="filter_icon.png"
                            BackgroundColor="Transparent"
                            WidthRequest="30"
                            HeightRequest="30"
                            Grid.Column="2"
                            Clicked="OnFilterClicked"/>
            </Grid>
        </Frame>

        <!-- CategorÃ­as populares -->
        <Label Text="CategorÃ­as Populares" 
               FontSize="18"
               FontAttributes="Bold"
               TextColor="{StaticResource TextPrimary}"
               Grid.Row="1"
               Margin="5,0,0,5"/>

        <ScrollView Grid.Row="2" 
                    Orientation="Horizontal"
                    HeightRequest="50"
                    Margin="0,0,0,15">
            <HorizontalStackLayout Spacing="10">
                <Button Text="ðŸ”¥ Populares" 
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        CornerRadius="15"
                        Padding="15,5"/>
                <Button Text="âš”ï¸ AcciÃ³n" 
                        BackgroundColor="{StaticResource BackgroundMedium}"
                        TextColor="{StaticResource TextSecondary}"
                        CornerRadius="15"
                        Padding="15,5"/>
                <Button Text="ðŸ’• Romance" 
                        BackgroundColor="{StaticResource BackgroundMedium}"
                        TextColor="{StaticResource TextSecondary}"
                        CornerRadius="15"
                        Padding="15,5"/>
                <Button Text="ðŸ‰ FantasÃ­a" 
                        BackgroundColor="{StaticResource BackgroundMedium}"
                        TextColor="{StaticResource TextSecondary}"
                        CornerRadius="15"
                        Padding="15,5"/>
                <Button Text="ðŸŽ® Sistema" 
                        BackgroundColor="{StaticResource BackgroundMedium}"
                        TextColor="{StaticResource TextSecondary}"
                        CornerRadius="15"
                        Padding="15,5"/>
                <Button Text="ðŸ° Cultivo" 
                        BackgroundColor="{StaticResource BackgroundMedium}"
                        TextColor="{StaticResource TextSecondary}"
                        CornerRadius="15"
                        Padding="15,5"/>
            </HorizontalStackLayout>
        </ScrollView>

        <!-- Grid de novelas -->
        <ScrollView Grid.Row="3">
            <CollectionView x:Name="novelsCollection">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" 
                                     Span="2" 
                                     VerticalItemSpacing="10" 
                                     HorizontalItemSpacing="10"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BackgroundColor="{StaticResource BackgroundMedium}"
                               CornerRadius="10"
                               Padding="0"
                               HasShadow="True"
                               HeightRequest="280">
                            <!-- Altura fija para consistencia -->
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnNovelTapped"/>
                            </Frame.GestureRecognizers>

                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="180"/>
                                    <!-- Altura fija para imagen -->
                                    <RowDefinition Height="*"/>
                                    <!-- Resto para informaciÃ³n -->
                                </Grid.RowDefinitions>

                                <!-- Imagen de portada con gradiente -->
                                <Grid Grid.Row="0">
                                    <Image Source="{Binding CoverImageSource}"
                                           Aspect="AspectFill"/>

                                    <!-- Gradiente inferior -->
                                    <BoxView>
                                        <BoxView.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                <GradientStop Color="Transparent" Offset="0.5"/>
                                                <GradientStop Color="#AA000000" Offset="1"/>
                                            </LinearGradientBrush>
                                        </BoxView.Background>
                                    </BoxView>

                                    <!-- Estado de la novela -->
                                    <Frame BackgroundColor="{Binding StatusColor}"
                                           CornerRadius="10"
                                           Padding="8,4"
                                           HorizontalOptions="Start"
                                           VerticalOptions="Start"
                                           Margin="5"
                                           HasShadow="False">
                                        <Label Text="{Binding Status}"
                                               TextColor="White"
                                               FontSize="10"
                                               FontAttributes="Bold"/>
                                    </Frame>
                                </Grid>

                                <!-- InformaciÃ³n de la novela -->
                                <Grid Grid.Row="1" 
                                      Padding="10,8"
                                      RowSpacing="2">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <!-- TÃ­tulo -->
                                        <RowDefinition Height="*"/>
                                        <!-- Espaciador -->
                                        <RowDefinition Height="Auto"/>
                                        <!-- Info -->
                                    </Grid.RowDefinitions>

                                    <!-- TÃ­tulo con lÃ­mite estricto -->
                                    <Label Grid.Row="0"
                                           Text="{Binding Title}"
                                           TextColor="{StaticResource TextPrimary}"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           MaxLines="2"
                                           LineBreakMode="TailTruncation"
                                           VerticalOptions="Start"/>

                                    <!-- Espaciador para empujar info hacia abajo -->
                                    <BoxView Grid.Row="1" Color="Transparent"/>

                                    <!-- Info siempre visible al fondo -->
                                    <Grid Grid.Row="2" ColumnSpacing="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <Label Grid.Column="0" 
                                               FontSize="11" 
                                               TextColor="{StaticResource TextSecondary}"
                                               VerticalOptions="End"
                                               HorizontalOptions="Start">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="ðŸ“– " FontSize="10"/>
                                                    <Span Text="{Binding ChapterCount}"/>
                                                    <Span Text=" caps"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>

                                        <Label Grid.Column="1"
                                               FontSize="11" 
                                               TextColor="#FFD700"
                                               VerticalOptions="End"
                                               HorizontalOptions="End">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="â­ " FontSize="10"/>
                                                    <Span Text="{Binding Rating}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </Grid>
                                </Grid>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>

        <!-- Indicador de carga -->
        <ActivityIndicator x:Name="loadingIndicator"
                          IsRunning="False"
                          IsVisible="False"
                          Color="{StaticResource Primary}"
                          Grid.Row="3"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"/>
    </Grid>
</ContentPage>